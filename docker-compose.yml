# docker-compose.yml  (Compose v2+ — no version key needed)

services:
  app:
    container_name: pretix_app
    build:
      context: ./docker/pretix
      dockerfile: Dockerfile
    restart: always
    depends_on:
      - database
      - cache
    environment:
      PRETIX_CONFIG_FILE: /etc/pretix/pretix.cfg
      # Pretix instance configuration
      PRETIX_PRETIX_INSTANCE_NAME: ${PRETIX_INSTANCE_NAME:-Pretix}
      PRETIX_PRETIX_URL: https://${PRETIX_DOMAIN:-pretix.weinerlebnistouren-pfalz.de}
      PRETIX_PRETIX_CURRENCY: ${PRETIX_CURRENCY:-EUR}
      # Database configuration
      PRETIX_DATABASE_BACKEND: postgresql
      PRETIX_DATABASE_NAME: ${POSTGRES_DB:-pretix}
      PRETIX_DATABASE_USER: ${POSTGRES_USER:-pretix}
      PRETIX_DATABASE_PASSWORD: ${POSTGRES_PASSWORD}
      PRETIX_DATABASE_HOST: database
      # Redis configuration
      PRETIX_REDIS_LOCATION: redis://cache/0
      PRETIX_REDIS_SESSIONS: "true"
      PRETIX_CELERY_BACKEND: redis://cache/1
      PRETIX_CELERY_BROKER: redis://cache/2
      # Mail configuration
      PRETIX_MAIL_FROM: ${MAIL_FROM}
      PRETIX_MAIL_HOST: ${MAIL_HOST}
      PRETIX_MAIL_USER: ${MAIL_USER:-}
      PRETIX_MAIL_PASSWORD: ${MAIL_PASSWORD:-}
      PRETIX_MAIL_PORT: ${MAIL_PORT:-587}
      PRETIX_MAIL_TLS: ${MAIL_TLS:-on}
      PRETIX_MAIL_SSL: ${MAIL_SSL:-off}
      # Locale configuration
      PRETIX_LOCALE_DEFAULT: ${PRETIX_LOCALE:-de}
      PRETIX_LOCALE_TIMEZONE: ${PRETIX_TIMEZONE:-Europe/Berlin}
    volumes:
      - pretix_data:/data
      # ⬇️ MUST be a real file in your repo
      - ./docker/pretix/pretix.cfg:/etc/pretix/pretix.cfg:ro
      # Note: nginx config is provided by the base image (pretix/standalone:stable)
      # Note: crontab is copied into the image during build (see Dockerfile line 9)
    # no host ports here; Traefik will route
    networks:
      - backend
      - coolify
    labels:
      - traefik.enable=true
      - traefik.docker.network=coolify

  database:
    image: postgres:17-alpine3.22
    container_name: database
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-pretix}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-pretix}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      backend:
        aliases: [database]    # explicit, for clarity

  cache:
    image: redis:alpine3.22
    container_name: redis
    restart: always
    networks:
      backend:
        aliases: [redis, cache]  # allow both names to resolve

volumes:
  postgres_data:
  pretix_data:

networks:
  backend:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.host_binding_ipv4: "127.0.0.1"
  coolify:
    external: true
